!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@nebular/theme"),require("@xaphira/ngxa-theme"),require("@angular/common"),require("@angular/forms"),require("@angular/common/http"),require("@ngx-translate/core"),require("@xaphira/shared"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@ng-idle/core"),require("@xaphira/ngxa-storage"),require("@xaphira/utils"),require("rxjs/add/operator/catch"),require("rxjs/add/observable/throw"),require("rxjs/add/observable/empty"),require("rxjs/add/operator/takeUntil")):"function"==typeof define&&define.amd?define("@xaphira/ngxa-auth",["exports","@angular/core","@nebular/theme","@xaphira/ngxa-theme","@angular/common","@angular/forms","@angular/common/http","@ngx-translate/core","@xaphira/shared","@angular/router","rxjs","rxjs/operators","@ng-idle/core","@xaphira/ngxa-storage","@xaphira/utils","rxjs/add/operator/catch","rxjs/add/observable/throw","rxjs/add/observable/empty","rxjs/add/operator/takeUntil"],t):t(((e=e||self).xaphira=e.xaphira||{},e.xaphira["ngxa-auth"]={}),e.ng.core,e["@nebular/theme"],e["@xaphira/ngxa-theme"],e.ng.common,e.ng.forms,e.ng.common.http,e["@ngx-translate/core"],e["@xaphira/shared"],e.ng.router,e.rxjs,e.rxjs.operators,e["@ng-idle/core"],e["@xaphira/ngxa-storage"],e["@xaphira/utils"])}(this,(function(e,t,r,n,o,a,s,i,u,c,l,p,h,d,f){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var g=function(e,t){return(g=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function m(e,t){function r(){this.constructor=e}g(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function y(e,t,r,n){return new(r||(r=Promise))((function(o,a){function s(e){try{u(n.next(e))}catch(e){a(e)}}function i(e){try{u(n.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,i)}u((n=n.apply(e,t||[])).next())}))}function b(e,t){var r,n,o,a,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(a){return function(i){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===a[0]||2===a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,i])}}}function v(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return s}function x(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(v(arguments[t]));return e}var S=function(e){function r(t){return e.call(this,t,"xa-core",1,"#xa-auth")||this}return m(r,e),r.prototype.getEnc=function(e,t){return y(this,void 0,void 0,(function(){var r,n=this;return b(this,(function(o){switch(o.label){case 0:return r=this.enc.getHmacSha256(this.oauthResource.private_key,e,!0),[4,this.$dbPromise];case 1:return[2,o.sent().get(t||"#xa-auth",r).then((function(e){return n.enc.decryptAES(n.oauthResource.aes_key,e)}))]}}))}))},r.prototype.putEnc=function(e,t,r){return y(this,void 0,void 0,(function(){var n,o;return b(this,(function(a){switch(a.label){case 0:return n=this.enc.getHmacSha256(this.oauthResource.private_key,e,!0),o=this.enc.encryptAES(this.oauthResource.aes_key,t),[4,this.$dbPromise];case 1:return[2,a.sent().put(r||"#xa-auth",o,n)]}}))}))},r.prototype.removeEnc=function(e,t){return y(this,void 0,void 0,(function(){var r;return b(this,(function(n){switch(n.label){case 0:return r=this.enc.getHmacSha256(this.oauthResource.private_key,e,!0),[4,this.$dbPromise];case 1:return[2,n.sent().delete(t||"#xa-auth",r)]}}))}))},r.prototype.getOfEnc=function(e,t){var r=new l.Subject;return this.getEnc(e,t).then((function(e){r.next(e)})),r.asObservable()},r.prototype.putOfEnc=function(e,t,r){var n=new l.Subject;return this.putEnc(e,t,r).then((function(e){n.next(e)})),n.asObservable()},r.prototype.removeOfEnc=function(e,t){var r=new l.Subject;return this.removeEnc(e,t).then((function(e){r.next(e)})),r.asObservable()},r.prototype.loginStorage=function(e){var t=this;u.oauthInfoModels.forEach((function(r){e[r.key]&&r.type===u.TypeDataOauth.OAUTH&&(r.enc?t.putEnc(r.key,r.string?e[r.key]:JSON.stringify(e[r.key])).then():t.put(r.key,r.string?e[r.key]:JSON.stringify(e[r.key])).then())}))},r.prototype.logout=function(){var e=this;u.oauthInfoModels.forEach((function(t){t.enc&&t.type===u.TypeDataOauth.OAUTH&&e.removeEnc(t.key).then()}))},r.prototype.isLogin=function(){return y(this,void 0,void 0,(function(){var e=this;return b(this,(function(t){switch(t.label){case 0:return[4,this.getEnc(u.oauthInfo.access_token)];case 1:return t.sent()?[2,!0]:(u.oauthInfoModels.forEach((function(t){e.removeEnc(t.key).then()})),[2,!1])}}))}))},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:t.Injector}]},r.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new r(t.ɵɵinject(t.INJECTOR))},token:r,providedIn:"root"}),r}(d.IndexedDBService),I=function(e){function r(t){return e.call(this,t,"xa-core",1,"#xa-profile")||this}return m(r,e),r.prototype.loginStorage=function(e){var t=this;u.oauthInfoModels.forEach((function(r){e[r.key]&&r.type===u.TypeDataOauth.PROFILE&&t.put(r.key,r.string?e[r.key]:JSON.stringify(e[r.key])).then()}))},r.prototype.logout=function(){var e=this;u.oauthInfoModels.forEach((function(t){t.type===u.TypeDataOauth.PROFILE&&e.remove(t.key)}))},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:t.Injector}]},r.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new r(t.ɵɵinject(t.INJECTOR))},token:r,providedIn:"root"}),r}(d.IndexedDBService),k=function(e){function r(t){var r=e.call(this,t,"xa-core",1,"#xa-settings")||this;return r.translate=t.get(i.TranslateService),r}return m(r,e),r.prototype.loginStorage=function(e){var t=this;u.oauthInfoModels.forEach((function(r){e[r.key]&&r.type===u.TypeDataOauth.SETTINGS&&(t.put(r.key,r.string?e[r.key]:JSON.stringify(e[r.key])).then(),"locale"===r.key&&t.translate.getTranslation(e[r.key]).subscribe((function(n){t.translate.use(e[r.key]),t.translate.setTranslation(e[r.key],n,!0)})))}))},r.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],r.ctorParameters=function(){return[{type:t.Injector}]},r.ngInjectableDef=t.ɵɵdefineInjectable({factory:function(){return new r(t.ɵɵinject(t.INJECTOR))},token:r,providedIn:"root"}),r}(d.IndexedDBService);var w=function(){function e(e,t,r,n,o,a,s,i){var u=this;this.httpBaseService=e,this.oauthResource=t,this.apiPath=r,this.router=n,this.authIndexedDB=o,this.profileIndexedDB=a,this.settingsIndexedDB=s,this.idle=i,i.setIdle(t.session_idle),i.setTimeout(t.session_timeout),i.setInterrupts(h.DEFAULT_INTERRUPTSOURCES),i.onTimeout.subscribe((function(){u.logout()})),i.onIdleEnd.subscribe((function(){}))}return e.prototype.login=function(e,t){var r=this;return this.authIndexedDB.logout(),this.httpBaseService.HTTP_BASE(this.apiPath.auth.token,this.getAuthBody(e,t).toString(),this.getAuthHeader()).toPromise().then((function(e){r.idle.setIdle(e.expires_in),r.idle.watch(),r.authIndexedDB.loginStorage(e),r.profileIndexedDB.loginStorage(e),r.settingsIndexedDB.loginStorage(e)}))},e.prototype.refresh=function(){var e=this;return this.getBodyRefresh().pipe(p.switchMap((function(t){return e.httpBaseService.HTTP_BASE(e.apiPath.auth.token,t,e.getAuthHeader()).pipe(p.tap((function(t){e.idle.setIdle(t.expires_in),e.authIndexedDB.logout(),e.authIndexedDB.loginStorage(t)})))})))},e.prototype.logout=function(){this.idle.stop(),this.authIndexedDB.logout(),this.profileIndexedDB.logout(),this.router.navigate(["/auth"])},e.prototype.isLogin=function(){return y(this,void 0,void 0,(function(){return b(this,(function(e){switch(e.label){case 0:return[4,this.authIndexedDB.isLogin()];case 1:return[2,e.sent()]}}))}))},e.prototype.oauthHeaders=function(e){var t=new l.Subject,r=e.headers?e.headers:new s.HttpHeaders;return r=r.has(u.signatureHeader.authorization)?r.delete(u.signatureHeader.authorization):r,Promise.all([this.authIndexedDB.getEnc(u.oauthInfo.token_type),this.authIndexedDB.getEnc(u.oauthInfo.access_token)]).then((function(n){r=r.set(u.signatureHeader.authorization,n[0]+" "+n[1]),t.next(e.clone({headers:r}))})),t.asObservable()},e.prototype.getAuthHeader=function(){return new s.HttpHeaders({"Content-Type":"application/x-www-form-urlencoded",Authorization:"Basic "+btoa(this.oauthResource.client_id+":"+this.oauthResource.client_secret),Accept:"application/json"})},e.prototype.getAuthBody=function(e,t){var r=new URLSearchParams;return r.append("client_id",this.oauthResource.client_id),r.append("grant_type",this.oauthResource.grant_type),r.append("username",e),r.append("password",t),r},e.prototype.getBodyRefresh=function(){var e=this,t=new l.Subject;return this.authIndexedDB.getEnc(u.oauthInfo.refresh_token).then((function(r){var n=new URLSearchParams;n.append("client_id",e.oauthResource.client_id),n.append("grant_type","refresh_token"),n.append("refresh_token",r),t.next(n.toString())})),t.asObservable()},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Inject,args:[u.HTTP_SERVICE]}]},{type:void 0,decorators:[{type:t.Inject,args:[u.OAUTH_INFO]}]},{type:void 0,decorators:[{type:t.Inject,args:[u.API]}]},{type:c.Router},{type:S},{type:I},{type:k},{type:h.Idle}]},e}();var T=function(){function e(e,t,r){this.router=e,this.authTokenService=t,this.authService=r}return e.prototype.canActivate=function(e,t){var r=this,n=new l.Subject;return this.authTokenService.isLogin().then((function(e){n.next(e),e?r.authService.loadPhotoUser():r.router.navigate(["/auth"])})),n.asObservable()},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:c.Router},{type:w},{type:u.UserInfo,decorators:[{type:t.Inject,args:[u.USER_INFO]}]}]},e}();var E=function(){function e(e,t){this.router=e,this.authTokenService=t}return e.prototype.canActivate=function(e,t){var r=this,n=new l.Subject;return this.authTokenService.isLogin().then((function(e){n.next(!e),e&&r.router.navigate(["/app"])})),n.asObservable()},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:c.Router},{type:w}]},e}();var j=function(){function e(e,t,r,n){this.router=e,this.authTokenService=t,this.enc=r,this.storage=n}return e.prototype.canActivateChild=function(e,t){var r=this,n=new l.Subject;return this.authTokenService.isLogin().then((function(t){n.next(t),e.data&&Promise.all([r.storage.getEnc("menus"),r.storage.getEnc("extras")]).then((function(t){return t[0].includes(e.data.code)||t[1].includes(e.data.code)||r.router.navigate(["/app/home"]),n.asObservable()})),t||r.router.navigate(["/auth"])})),n.asObservable()},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:c.Router},{type:w},{type:f.EncryptionService},{type:S}]},e}();var B=function(){function e(e,t){this.router=e,this.authTokenService=t,this.buttonLogin=!1,this.progressBar=25,this.form=new a.FormGroup({username:new a.FormControl,password:new a.FormControl})}return e.prototype.login=function(){var e=this;if(!this.form.invalid){document.querySelectorAll(".pace-done").forEach((function(e){e.className=e.className.replace("pace-done pace-done","pace-running"),e.className=e.className.replace("pace-done","pace-running")})),document.querySelectorAll(".pace-inactive").forEach((function(e){e.className=e.className.replace("pace-inactive pace-inactive","pace-active"),e.className=e.className.replace("pace-inactive","pace-active")}));var t=document.getElementsByClassName("pace-progress").item(0);this.progressBar<35&&(this.progressBar=35,t.style.transform="translate3d("+this.progressBar+"%, 0px, 0px)",t.getAttributeNode("data-progress-text").value=this.progressBar+"%",t.getAttributeNode("data-progress").value=this.progressBar.toString()),this.buttonLogin=!0,this.authTokenService.login(this.form.get("username").value,this.form.get("password").value).then((function(){e.progressBar=90,t.style.transform="translate3d("+e.progressBar+"%, 0px, 0px)",t.getAttributeNode("data-progress-text").value=e.progressBar+"%",t.getAttributeNode("data-progress").value=e.progressBar.toString(),e.progressBar=0,e.router.navigate(["/app/home"])})).catch((function(r){if(!(r instanceof s.HttpErrorResponse)){var n=r;e.responseError=n.respStatusMessage[n.respStatusCode]}e.buttonLogin=!1,e.progressBar=85,t.style.transform="translate3d("+e.progressBar+"%, 0px, 0px)",t.getAttributeNode("data-progress-text").value=e.progressBar+"%",t.getAttributeNode("data-progress").value=e.progressBar.toString(),document.querySelectorAll(".pace-running").forEach((function(e){e.className=e.className.replace("pace-running","pace-done")})),document.querySelectorAll(".pace-active").forEach((function(e){e.className=e.className.replace("pace-active","pace-inactive")})),e.progressBar=0})),this.progressBar>=35&&this.progressBar<65&&(this.progressBar=65,t.style.transform="translate3d("+this.progressBar+"%, 0px, 0px)",t.getAttributeNode("data-progress-text").value=this.progressBar+"%",t.getAttributeNode("data-progress").value=this.progressBar.toString())}},Object.defineProperty(e.prototype,"hasErrorUsername",{get:function(){return this.form.controls.username&&this.form.controls.username.invalid&&this.form.controls.username.touched},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasSuccessUsername",{get:function(){return this.form.controls.username&&this.form.controls.username.valid&&this.form.controls.username.touched},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasErrorPassword",{get:function(){return this.form.controls.password&&this.form.controls.password.invalid&&this.form.controls.password.touched},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hasSuccessPassword",{get:function(){return this.form.controls.password&&this.form.controls.password.valid&&this.form.controls.password.touched},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Component,args:[{selector:"xa-login-page",template:'<h1 id="title" class="title">{{ \'Login\' | translate }}</h1>\n<p class="sub-title">{{ \'subtitle.login\' | translate }}</p>\n<nb-alert *ngIf="responseError" outline="danger" role="alert">\n  <p class="alert-title"><b>{{ \'alert.title.login\' | translate }}</b></p>\n  <ul class="alert-message-list">\n    <li class="alert-message">{{ responseError }}</li>\n  </ul>\n</nb-alert>\n\n<form [formGroup]="form" (ngSubmit)="login()" aria-labelledby="title">\n  <div class="form-control-group">\n    <label class="label">{{ \'Username\' | translate }} :</label>\n    <input [formControlName]="\'username\'"\n          [required]="true"\n          [ngClass]="{\n            \'status-danger\': hasErrorUsername,\n            \'status-success\': hasSuccessUsername\n          }"\n          name="username"\n          id="inputUsername"\n          placeholder="{{ \'Username\' | translate }}"\n          fieldSize="large"\n          autofocus\n          nbInput\n          fullWidth>\n    <ng-container *ngIf="hasErrorUsername">\n      <span class="caption status-danger">{{\'error.username\' | translate}}</span>\n    </ng-container>\n  </div>\n\n  <div class="form-control-group">\n    <label class="label">{{ \'Password\' | translate }} :</label>\n    <input [formControlName]="\'password\'"\n          [required]="true"\n          [ngClass]="{\n            \'status-danger\': hasErrorPassword,\n            \'status-success\': hasSuccessPassword\n          }"\n          name="password"\n          type="password"\n          id="inputPassword"\n          placeholder="{{ \'Password\' | translate }}"\n          fieldSize="large"\n          nbInput\n          fullWidth>\n    <ng-container *ngIf="hasErrorPassword">\n      <span class="caption status-danger">{{ \'error.password\' | translate}}</span>\n    </ng-container>\n  </div>\n\n  <button [disabled]="form.invalid || buttonLogin"\n          fullWidth\n          nbButton\n          status="primary"\n          size="large"\n          [class.btn-pulse]="form.invalid || buttonLogin">\n    {{ \'Login\' | translate }}\n  </button>\n</form>\n',styles:[""]}]}],e.ctorParameters=function(){return[{type:c.Router},{type:w}]},e}();var P=function(){function e(e){this.authTokenService=e,this.authTokenService.logout()}return e.decorators=[{type:t.Component,args:[{selector:"xa-logout",template:""}]}],e.ctorParameters=function(){return[{type:w}]},e}();var D=function(){function e(e){this.location=e}return e.prototype.back=function(){return this.location.back(),!1},e.prototype.ngOnDestroy=function(){this.alive=!1},e.decorators=[{type:t.Component,args:[{selector:"xa-auth",template:'<nb-layout>\n    <nb-layout-column>\n        <nb-card>\n            <nb-card-header>\n                <nav class="navigation">\n                    <a href="#" (click)="back()" class="link back-link" aria-label="Back">\n                        <nb-icon icon="arrow-back"></nb-icon>\n                    </a>\n                </nav>\n            </nb-card-header>\n            <nb-card-body>\n                <xa-auth-block>\n                    <router-outlet></router-outlet>\n                </xa-auth-block>\n            </nb-card-body>\n        </nb-card>\n    </nb-layout-column>\n</nb-layout>',styles:["/*!\n * @license\n * Copyright Akveo. All Rights Reserved.\n * Licensed under the MIT License. See License.txt in the project root for license information.\n */:host nb-card{margin:0;height:calc(100vh - 2 * 2.5rem)}:host .navigation .link{display:inline-block;text-decoration:none}:host .navigation .link nb-icon{font-size:2rem;vertical-align:middle}:host .links nb-icon{font-size:2.5rem}:host nb-card-body{display:flex;width:100%}:host xa-auth-block{margin:auto}:host ::ng-deep nb-layout .layout .layout-container .content .columns nb-layout-column{padding:2.5rem}@media (max-width:767.98px){:host nb-card{border-radius:0;height:100vh}:host ::ng-deep nb-layout .layout .layout-container .content .columns nb-layout-column{padding:0}}"]}]}],e.ctorParameters=function(){return[{type:o.Location}]},e}();var O=[{path:"",component:D,children:[{path:"",component:B,canActivate:[E]},{path:"login",component:B,canActivate:[E]},{path:"logout",component:P,canActivate:[T]}]}],H=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[c.RouterModule.forChild(O)],exports:[c.RouterModule]}]}],e}(),N=function(){function e(){}return e.decorators=[{type:t.Component,args:[{selector:"xa-auth-block",template:"\n    <ng-content></ng-content>\n  ",styles:[":host{display:block;width:100%;max-width:35rem}:host ::ng-deep form{width:100%}:host ::ng-deep .label{display:block;margin-bottom:.5rem}:host ::ng-deep .forgot-password{text-decoration:none;margin-bottom:.5rem}:host ::ng-deep .caption{margin-top:.5rem}:host ::ng-deep .alert{text-align:center}:host ::ng-deep .title{margin-top:0;margin-bottom:.75rem;text-align:center}:host ::ng-deep .sub-title{margin-bottom:2rem;text-align:center}:host ::ng-deep .form-control-group{margin-bottom:2rem}:host ::ng-deep .form-control-group.accept-group{display:flex;justify-content:space-between;margin:2rem 0}:host ::ng-deep .label-with-link{display:flex;justify-content:space-between}:host ::ng-deep .links{text-align:center;margin-top:1.75rem}:host ::ng-deep .links .socials{margin-top:1.5rem}:host ::ng-deep .links .socials a{margin:0 1rem;text-decoration:none;vertical-align:middle}:host ::ng-deep .links .socials a.with-icon{font-size:2rem}:host ::ng-deep .another-action{margin-top:2rem;text-align:center}:host ::ng-deep .sign-in-or-up{margin-top:2rem;display:flex;justify-content:space-between}:host ::ng-deep nb-alert .alert-message,:host ::ng-deep nb-alert .alert-title{margin:0 0 .5rem}:host ::ng-deep nb-alert .alert-message-list{list-style-type:none;padding:0;margin:0}"]}]}],e}(),R=[D,N],M=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:x(R),imports:[r.NbLayoutModule,r.NbCardModule,r.NbIconModule,o.CommonModule,s.HttpClientModule,n.NgxaThemeModule,c.RouterModule],exports:x(R)}]}],e}(),_=function(){function e(e,t,r,n){this.translate=e,this.enc=t,this.oauthResource=r,this.authStorage=n}return e.prototype.signHeaders=function(e){var t=this;return l.combineLatest([this.key(),this.signature(this.getPath(e.url))]).pipe(p.take(1),p.switchMap((function(r){if(u.signatureHeader.signature){var n=e.headers?e.headers:new s.HttpHeaders;return n.keys().forEach((function(e){e===u.signatureHeader.key&&(n=n.delete(u.signatureHeader.key)),e===u.signatureHeader.timestamp&&(n=n.delete(u.signatureHeader.timestamp)),e===u.signatureHeader.signature&&(n=n.delete(u.signatureHeader.signature))})),n=(n=(n=n.set(u.signatureHeader.key,r[0])).set(u.signatureHeader.timestamp,t.timestamp())).set(u.signatureHeader.signature,r[1]),l.of(e.clone({headers:n}))}return l.of(e)})))},e.prototype.key=function(){return this.authStorage.getOfEnc(u.oauthInfo.public_key)},e.prototype.timestamp=function(){return Math.floor((new Date).getTime()/1e3).toString()},e.prototype.date=function(){return new o.DatePipe(this.translate.currentLang).transform(new Date,f.DateFormat.DATE)},e.prototype.signature=function(e){var t=this;return l.combineLatest([this.key(),this.authStorage.getOfEnc(u.oauthInfo.access_token)]).pipe(p.take(1),p.switchMap((function(r){var n=r[0]+":"+t.timestamp()+":"+t.date()+":"+e+":"+r[1];return l.of(t.enc.getHmacSha256(t.oauthResource.private_key,n))})))},e.prototype.getPath=function(e){return"/"+e.replace(/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*(:[0-9]{1,5})?(\/).*?/g,"")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:i.TranslateService},{type:f.EncryptionService},{type:void 0,decorators:[{type:t.Inject,args:[u.OAUTH_INFO]}]},{type:S}]},e}();var A=function(){function e(e){this.authToken=e,this.destroy$=new l.Subject}return e.prototype.ngOnDestroy=function(){this.destroy$.next(!0),this.destroy$.complete(),this.destroy$.unsubscribe()},e.prototype.intercept=function(e,t){return e.headers&&e.headers.has(u.signatureHeader.mark)?this.authToken.oauthHeaders(e).pipe(p.switchMap((function(e){return t.handle(e)}))):t.handle(e).takeUntil(this.destroy$)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:w}]},e}();var C=function(){function e(e,t){this.authSignature=e,this.oauthResource=t,this.destroy$=new l.Subject}return e.prototype.ngOnDestroy=function(){this.destroy$.next(!0),this.destroy$.complete(),this.destroy$.unsubscribe()},e.prototype.intercept=function(e,t){return e.headers&&e.headers.has(u.signatureHeader.mark)&&this.oauthResource.signature?this.authSignature.signHeaders(e).pipe(p.switchMap((function(e){return t.handle(e)}))):t.handle(e).takeUntil(this.destroy$)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:_},{type:void 0,decorators:[{type:t.Inject,args:[u.OAUTH_INFO]}]}]},e}();var U=function(){function e(e,t){this.locale=e,this.settingsIndexedDB=t}return e.prototype.getLocale=function(e){var t=this;return l.from(this.settingsIndexedDB.get("locale")).pipe(p.take(1),p.switchMap((function(r){var n=e.headers?e.headers:new s.HttpHeaders,o=r&&r.match(new RegExp(f.Pattern.LOCALE,"g"))?r:t.locale;return n=n.append("Accept-Language",o),l.of(e.clone({headers:n}))})))},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:String,decorators:[{type:t.Inject,args:[t.LOCALE_ID]}]},{type:k}]},e}();var L=function(){function e(e){this.authLanguage=e,this.destroy$=new l.Subject}return e.prototype.ngOnDestroy=function(){this.destroy$.next(!0),this.destroy$.complete(),this.destroy$.unsubscribe()},e.prototype.intercept=function(e,t){return e.headers&&e.headers.has(u.signatureHeader.mark)?this.authLanguage.getLocale(e).pipe(p.switchMap((function(e){return t.handle(e)}))):t.handle(e).takeUntil(this.destroy$)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:U}]},e}();var $=function(){function e(e,t,r,n){this.translate=e,this.authToken=t,this.authStorage=r,this.authSignature=n,this.isRefreshingToken=!1,this.refreshTokenSubject=new l.BehaviorSubject(null)}return e.prototype.errorHandler=function(e,t,r){var n=new s.HttpErrorResponse({error:e.error,headers:e.headers,status:e.status,statusText:e.statusText,url:e.url});if(e.error instanceof ArrayBuffer){var o=String.fromCharCode.apply(null,new Uint8Array(e.error));n=new s.HttpErrorResponse({error:JSON.parse(o),headers:e.headers,status:e.status,statusText:e.statusText,url:e.url})}switch(n.status){case 200:case 201:case 304:return l.Observable.empty();case 400:return this.error400(n);case 401:return this.error401(n,t,r);case 404:case 403:case 500:case 504:case 0:return l.Observable.throw(this.errorDefault(n))}return l.Observable.throw(n)},e.prototype.errorDefault=function(e){var t={respStatusCode:e.status,respStatusMessage:{}};t.respStatusMessage[t.respStatusCode]=e.statusText;var r="error."+t.respStatusCode;return e.error&&e.error.respStatusCode&&(r=(t=e.error).respStatusMessage[t.respStatusCode]),this.translate.get(r).subscribe((function(e){t.respStatusMessage[t.respStatusCode]=e})),t},e.prototype.error400=function(e){if(e.error.respStatusCode){if("invalid_grant"!==e.error.respStatusCode)return l.Observable.throw(this.errorDefault(e));switch(e.error.respStatusMessage.invalid_grant){case"Bad credentials":case"User account is locked":case"User is disabled":case"User account has expired":return l.Observable.throw(this.errorDefault(e));default:return this.authToken.logout(),l.Observable.throw(this.errorDefault(e))}}return l.Observable.throw(e)},e.prototype.error401=function(e,t,r){var n=this;if(e.error&&"invalid_token"===e.error.respStatusCode){if(!this.isRefreshingToken)return this.isRefreshingToken=!0,this.refreshTokenSubject.next(null),this.authToken.refresh().pipe(p.switchMap((function(e){return n.isRefreshingToken=!1,n.refreshTokenSubject.next(e),n.authToken.oauthHeaders(t).pipe(p.switchMap((function(e){return t=e,n.authSignature.signHeaders(t).pipe(p.switchMap((function(e){return r.handle(e)})))})))})),p.catchError((function(e){return n.errorHandler(e,t,r)})));if(!e.error.respStatusMessage.invalid_token.includes("expired"))return this.refreshTokenSubject.pipe(p.filter((function(e){return null!=e})),p.take(1),p.switchMap((function(){return n.authToken.oauthHeaders(t).pipe(p.switchMap((function(e){return t=e,n.authSignature.signHeaders(t).pipe(p.switchMap((function(e){return r.handle(e)})))})))})));this.authToken.logout()}return l.Observable.throw(e)},e}();var q=function(e){function r(t,r,n,o){var a=e.call(this,t,r,n,o)||this;return a.translate=t,a.authToken=r,a.authStorage=n,a.authSignature=o,a.destroy$=new l.Subject,a}return m(r,e),r.prototype.ngOnDestroy=function(){this.destroy$.next(!0),this.destroy$.complete(),this.destroy$.unsubscribe()},r.prototype.intercept=function(e,t){var r=this;return t.handle(e).pipe(p.catchError((function(n){return n instanceof s.HttpErrorResponse?r.errorHandler(n,e,t):l.Observable.throw(n)}))).takeUntil(this.destroy$)},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[{type:i.TranslateService},{type:w},{type:S},{type:_}]},r}($);var F=function(e){function r(t,r,n){var o=e.call(this)||this;return o.profileIndexedDB=t,o.apiPath=r,o.httpBaseService=n,o.loaderUserSubject$=new l.Subject,o}return m(r,e),r.prototype.loadPhotoUser=function(){var e=this;Promise.all([this.profileIndexedDB.get("image-b64"),this.profileIndexedDB.get("image"),this.profileIndexedDB.get("name")]).then((function(t){t[0]?Promise.all([e.profileIndexedDB.get("name"),e.profileIndexedDB.get("image-b64")]).then((function(t){var r={name:t[0],picture:t[1]};e.loaderUserSubject$.next(r)})):t[1]&&t[2]?e.getImage(t[1],t[2]):e.httpBaseService.HTTP_AUTH(e.apiPath.profile["get-profile"]).subscribe((function(t){Promise.all([e.profileIndexedDB.put("name",t.name),e.profileIndexedDB.put("email",t.email),e.profileIndexedDB.put("image",t.image)]).then((function(){e.getImage(t.image,t.name)}))}))}))},r.prototype.updatePhotoUser=function(e,t){var r=this;if(e&&t){var n,o=new Blob([e],{type:"image/png"});this.profileIndexedDB.put(u.oauthInfo.image,t).then(),this.profileIndexedDB.put("image-blob",o).then(),this.profileIndexedDB.get("name").then((function(e){var t=new FileReader;t.readAsDataURL(o),t.onloadend=function(){n=t.result.toString();var o={name:e,picture:n};r.profileIndexedDB.put("image-b64",n).then(),r.loaderUserSubject$.next(o)}}))}else this.loaderUserSubject$.next(null);return this.loaderUserSubject$.asObservable()},r.prototype.getUser=function(){return this.loaderUserSubject$.asObservable()},r.prototype.getImage=function(e,t){var r=this;this.httpBaseService.HTTP_AUTH(this.apiPath.file["vw-photo-profile"],null,null,null,[e],"arraybuffer").pipe(p.tap((function(e){var n,o=new Blob([e],{type:"image/png"});r.profileIndexedDB.put("image-blob",o).then();var a=new FileReader;a.readAsDataURL(o),a.onloadend=function(){n=a.result.toString();var e={name:t,picture:n};r.profileIndexedDB.put("image-b64",n).then(),r.loaderUserSubject$.next(e)}}))).subscribe()},r.decorators=[{type:t.Injectable}],r.ctorParameters=function(){return[{type:I},{type:void 0,decorators:[{type:t.Inject,args:[u.API]}]},{type:void 0,decorators:[{type:t.Inject,args:[u.HTTP_SERVICE]}]}]},r}(u.UserInfo);var z=[{provide:s.HTTP_INTERCEPTORS,useClass:A,multi:!0},{provide:s.HTTP_INTERCEPTORS,useClass:C,multi:!0},{provide:s.HTTP_INTERCEPTORS,useClass:L,multi:!0},{provide:s.HTTP_INTERCEPTORS,useClass:q,multi:!0},{provide:u.USER_INFO,useClass:F},{provide:u.AUTH_INDEXED_DB,useClass:S},{provide:u.PROFILE_INDEXED_DB,useClass:I},{provide:u.SETTINGS_INDEXED_DB,useClass:k},T,E,w,j,_,U],G=[B,P],J=function(){function e(){}return e.forRoot=function(){return{ngModule:e,providers:x(z)}},e.decorators=[{type:t.NgModule,args:[{declarations:x(G),imports:[r.NbCheckboxModule,r.NbAlertModule,r.NbInputModule,r.NbButtonModule,r.NbIconModule,o.CommonModule,a.FormsModule,i.TranslateModule,a.ReactiveFormsModule,s.HttpClientModule,n.NgxaThemeModule,M,H],exports:x(G)}]}],e}(),W=function(){function e(e){this.location=e}return e.prototype.goToHome=function(){this.location.back()},e.decorators=[{type:t.Component,args:[{selector:"xa-404",template:'<div class="flex-centered">\n  <h2 class="title">404</h2>\n  <h2 class="title">Page Not Found</h2>\n  <small class="sub-title">The page you were looking for doesn\'t exist</small>\n  <button nbButton fullWidth (click)="goToHome()" type="button" class="home-button">\n    Take me home\n  </button>\n</div>\n',styles:[".flex-centered{margin:auto}nb-card-body{display:flex}.title{text-align:center}.sub-title{text-align:center;display:block;margin-bottom:3rem}.home-button{margin-bottom:2rem}"]}]}],e.ctorParameters=function(){return[{type:o.Location}]},e}();var X=[{path:"",component:D,children:[{path:"404",component:W}]}],V=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[c.RouterModule.forChild(X)],exports:[c.RouterModule]}]}],e}(),K=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[r.NbButtonModule,r.NbIconModule,o.CommonModule,n.NgxaThemeModule,M,V],declarations:[W]}]}],e}();e.AuthGuardChildService=j,e.AuthGuardService=T,e.AuthIndexedDBService=S,e.AuthSignatureService=_,e.AuthTokenService=w,e.AuthUserService=F,e.MiscellaneousModule=K,e.NgxaAuthModule=J,e.PageNotFoundComponent=W,e.ProfileIndexedDBService=I,e.SettingsIndexedDBService=k,e.UnauthorizeGuardService=E,e.ɵa=B,e.ɵb=P,e.ɵc=M,e.ɵd=D,e.ɵe=N,e.ɵf=H,e.ɵg=A,e.ɵh=C,e.ɵi=L,e.ɵj=U,e.ɵk=q,e.ɵl=$,e.ɵm=V,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=xaphira-ngxa-auth.umd.min.js.map